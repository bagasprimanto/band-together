{% extends "_base.html" %}
{% load crispy_forms_tags %}
{% block title %}Profile Edit - BandTogether{% endblock title %}

{% block content %}
<div class="container my-5 col-sm-10 col-md-8 col-12 border border-1 p-5 rounded shadow">

    <!-- Back to Profile button -->
    <a href="{% url 'profiles:profile_detail' user.profile.slug %}"class="btn btn-secondary mb-2">‚Üê Back to Profile</a>

    <!-- Title -->
    <h1 class="fw-bold">Edit Profile</h1>

    <!-- Tabs -->
    <section class="tabs mb-3">
        <ul class="nav nav-underline">
            <li class="nav-item">
                <a {% if "/general-info/" in request.path %} class="nav-link active" {% else %} class="nav-link" {% endif %} 
                    href="{% url 'profiles:profile_edit_general_info' user.profile.slug %}">General Info</a>
            </li>
            <li class="nav-item">
                <a {% if "/additional-info/" in request.path %} class="nav-link active" {% else %} class="nav-link" {% endif%} 
                    href="{% url 'profiles:profile_edit_additional_info' user.profile.slug %}">Influences & Additional Info</a>
            </li>
            <li class="nav-item">
                <a {% if "/pictures/" in request.path %} class="nav-link active" {% else %} class="nav-link" {% endif%} 
                    href="{% url 'profiles:profile_edit_pictures' user.profile.slug %}">Pictures</a>
            </li>
            <li class="nav-item">
                <a {% if "/genres/" in request.path %} class="nav-link active" {% else %} class="nav-link" {% endif%} 
                    href="{% url 'profiles:profile_edit_genres' user.profile.slug %}">Genres</a>
            </li>
            <li class="nav-item">
                <a {% if "/skills/" in request.path %} class="nav-link active" {% else %} class="nav-link" {% endif%} 
                    href="{% url 'profiles:profile_edit_skills' user.profile.slug %}">Skills</a>
            </li>
            <li class="nav-item">
                <a {% if "/music-videos/" in request.path %} class="nav-link active" {% else %} class="nav-link" {% endif%} 
                    href="{% url 'profiles:profile_edit_music_videos' user.profile.slug %}">Music Videos</a>
            </li>
            <li class="nav-item">
                <a {% if "/socials/" in request.path %} class="nav-link active" {% else %} class="nav-link" {% endif%} 
                    href="{% url 'profiles:profile_edit_socials' user.profile.slug %}">Social Media Links</a>
            </li>
        </ul>
    </section>

    <legend class="mb-4 text-muted fs-4 fw-normal border-bottom">
        {% block edit_form_legend %}
        {% endblock edit_form_legend %}
    </legend>
    {% block edit_form %}
    {% endblock edit_form %}
</div>

<!-- Modal HTML (Bootstrap 5) -->
<div class="modal fade" id="unsavedChangesModal" tabindex="-1" aria-labelledby="unsavedChangesModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="unsavedChangesModalLabel">Unsaved Changes</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                You have unsaved changes. Are you sure you want to leave this page?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Stay on Page</button>
                <button type="button" class="btn btn-primary" id="leavePageButton">Leave Page</button>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block additional_js %}
<script>
    document.addEventListener("DOMContentLoaded", function() {
        const form = document.querySelector("form"); // Assuming there's only one form on the page
        const submitButton = form.querySelector("input[type='submit']");
        let formIsChanged = false;
    
        initFormHash(form); // Initialize the form hash
    
        form.addEventListener("input", function() {
            formIsChanged = formChanged(form); // Check if form is changed on any input
        });
    
        submitButton.addEventListener("click", function() {
            // Temporarily disable the beforeunload event when the form is being submitted
            window.removeEventListener("beforeunload", beforeUnloadHandler);
        });
    
        window.addEventListener("beforeunload", beforeUnloadHandler);
    
        function beforeUnloadHandler(e) {
            if (formIsChanged) {
                const confirmationMessage = 'You have unsaved changes. Are you sure you want to leave this page?';
                e.returnValue = confirmationMessage; // Standard for most browsers
                return confirmationMessage;          // Standard for most modern browsers
            }
        }
    });
    
    function initFormHash(form) {
        form.setAttribute("data-initial-hash", getFormHash(form));
    }
    
    function getFormHash(form) {
        const formValues = {};
    
        form.querySelectorAll("input, textarea, select").forEach(input => {
            const inputType = input.getAttribute("type");
            const inputName = input.getAttribute("name");
    
            if (inputType === "hidden" || !inputName) return;
    
            if (inputType === "checkbox" || inputType === "radio") {
                formValues[inputName] = input.checked;
            } else {
                formValues[inputName] = input.value;
            }
        });
    
        return JSON.stringify(formValues);
    }
    
    function formChanged(form) {
        return (form.getAttribute("data-initial-hash") !== getFormHash(form));
    }      
</script>
{% endblock additional_js %}